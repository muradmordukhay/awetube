name: Deploy

on:
  # Auto-deploy QA when code is pushed to develop
  push:
    branches: [develop]
  # Manual deploy for either environment
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options:
          - qa
          - production

# Prevent concurrent deploys to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'qa' }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'qa' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Determine spec file
        id: spec
        run: |
          ENV="${{ github.event.inputs.environment || 'qa' }}"
          if [ "$ENV" = "production" ]; then
            echo "file=.do/app.yaml" >> "$GITHUB_OUTPUT"
          else
            echo "file=.do/app.staging.yaml" >> "$GITHUB_OUTPUT"
          fi

      # Substitute secret placeholders and update the app spec.
      # Uses explicit var list so ${db.DATABASE_URL} (a DO internal ref) is NOT replaced.
      # GitHub Actions automatically masks secret values in log output.
      - name: Update app spec
        env:
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          CALLBACK_SIGNING_SECRET: ${{ secrets.CALLBACK_SIGNING_SECRET }}
          QENCODE_API_KEY: ${{ secrets.QENCODE_API_KEY }}
          QENCODE_S3_BUCKET: ${{ secrets.QENCODE_S3_BUCKET }}
          NEXT_PUBLIC_QENCODE_PLAYER_LICENSE: ${{ secrets.NEXT_PUBLIC_QENCODE_PLAYER_LICENSE }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          GIT_SHA: ${{ github.sha }}
        run: |
          envsubst '$NEXTAUTH_SECRET $CALLBACK_SIGNING_SECRET $QENCODE_API_KEY $QENCODE_S3_BUCKET $NEXT_PUBLIC_QENCODE_PLAYER_LICENSE $RESEND_API_KEY $GIT_SHA' \
            < "${{ steps.spec.outputs.file }}" \
            | doctl apps update "${{ secrets.DO_APP_ID }}" --spec -

      # Force rebuild ensures DO pulls the latest commit even if the spec didn't change.
      # Capture the deployment ID from THIS step (not the spec update) since force-rebuild
      # supersedes the spec-update deployment.
      - name: Force rebuild
        id: rebuild
        run: |
          doctl apps create-deployment "${{ secrets.DO_APP_ID }}" --force-rebuild
          sleep 5
          DEPLOY_ID=$(doctl apps list-deployments "${{ secrets.DO_APP_ID }}" \
            --format ID --no-header | head -1)
          echo "deploy_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"
          echo "Triggered deployment: $DEPLOY_ID"

      - name: Wait for deployment
        run: |
          DEPLOY_ID="${{ steps.rebuild.outputs.deploy_id }}"
          echo "Polling deployment $DEPLOY_ID ..."
          for i in $(seq 1 40); do
            STATUS=$(doctl apps get-deployment "${{ secrets.DO_APP_ID }}" "$DEPLOY_ID" \
              --format Phase --no-header)
            echo "  Attempt $i/40 — status: $STATUS"
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "✓ Deployment successful"
              exit 0
            fi
            if [ "$STATUS" = "ERROR" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "✗ Deployment failed with status: $STATUS"
              echo "--- Build logs (last 30 lines) ---"
              doctl apps logs "${{ secrets.DO_APP_ID }}" --type=build | tail -30
              exit 1
            fi
            sleep 15
          done
          echo "✗ Deployment timed out after 10 minutes"
          exit 1

      - name: Verify deployment
        if: success()
        env:
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          ENV="${{ github.event.inputs.environment || 'qa' }}"
          if [ "$ENV" = "production" ]; then
            URL="https://awetube.ai"
          else
            URL="https://qa.awetube.ai"
          fi
          sleep 15

          # Health check
          echo "Checking health at $URL/api/health ..."
          HEALTH=$(curl -sf "$URL/api/health" || echo '{"status":"error"}')
          echo "Health response: $HEALTH"
          echo "$HEALTH" | grep -q '"status":"ok"' || { echo "✗ Health check failed"; exit 1; }
          echo "✓ Health check passed"

          # SHA check
          echo "Checking deployed commit at $URL/api/version ..."
          sleep 10
          RESP=$(curl -sS "$URL/api/version?t=$EXPECTED_SHA" || true)
          echo "Response: $RESP"
          SHA=$(echo "$RESP" | jq -r '.sha // empty')
          if [ -z "$SHA" ]; then
            echo "✗ Could not read commit SHA from /api/version"
            exit 1
          fi
          if [ "$SHA" != "$EXPECTED_SHA" ]; then
            echo "✗ SHA mismatch. Expected $EXPECTED_SHA but got $SHA"
            exit 1
          fi
          echo "✓ SHA verified: $SHA"
